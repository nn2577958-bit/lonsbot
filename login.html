<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Palworld ë¡œê·¸ì¸/íšŒì›ê°€ì…</title>
<link rel="stylesheet" href="./style.css">
<style>
  .error { color:red; margin-bottom:10px; }
  .login-btn, .signup-btn, .google-btn, .phone-btn { display:block; margin:10px 0; padding:8px 12px; }
</style>
</head>
<body>
<div class="container">
  <h2>Palworld ë¡œê·¸ì¸/íšŒì›ê°€ì…</h2>
  <div id="login-msg" class="error"></div>

  <input type="text" id="phone" placeholder="ì „í™”ë²ˆí˜¸ (+82...)">
  <div id="recaptcha-container"></div>
  <input type="text" id="otp" placeholder="OTP ì…ë ¥">

  <button id="phone-btn" class="phone-btn">ì „í™”ë²ˆí˜¸ ì¸ì¦</button>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { 
  RecaptchaVerifier, 
  signInWithPhoneNumber 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const phoneInput = document.getElementById("phone");
const otpInput = document.getElementById("otp");
const phoneBtn = document.getElementById("phone-btn");
const loginMsg = document.getElementById("login-msg");

let confirmationResult;

// ğŸ”¹ ì „í™”ë²ˆí˜¸ ì¸ì¦ ì‹œì‘
phoneBtn.addEventListener("click", async () => {
  loginMsg.textContent = "";
  const phoneNumber = phoneInput.value.trim();
  if (!phoneNumber) { loginMsg.textContent = "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }

  // reCAPTCHA
  window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {}, auth);

  try {
    confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
    alert("SMSë¡œ OTPê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë°›ìœ¼ì‹  6ìë¦¬ ì½”ë“œ ì…ë ¥ í›„ ë‹¤ì‹œ í´ë¦­í•´ì£¼ì„¸ìš”.");

    // OTP ì…ë ¥ í›„ ì¸ì¦ ì²˜ë¦¬
    phoneBtn.textContent = "OTP ì¸ì¦ ì™„ë£Œ";
    phoneBtn.onclick = async () => {
      const code = otpInput.value.trim();
      if (!code) { loginMsg.textContent = "OTPë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
      try {
        const userCredential = await confirmationResult.confirm(code);
        const user = userCredential.user;

        // Firestore ì‚¬ìš©ì ì •ë³´ í™•ì¸/ìƒì„±
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          await setDoc(userRef, { 
            phone: phoneNumber, 
            isMember: false, 
            createdAt: new Date() 
          });
        }

        // ì¸ì¦ ì™„ë£Œ â†’ í™ˆ í™”ë©´ ì´ë™
        window.location.href = "home.html";

      } catch (err) {
        console.error(err);
        loginMsg.textContent = "OTP ì¸ì¦ ì‹¤íŒ¨: " + err.message;
      }
    };

  } catch (err) {
    console.error(err);
    loginMsg.textContent = "SMS ë°œì†¡ ì‹¤íŒ¨: " + err.message;
  }
});
</script>
</body>
</html>
