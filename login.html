<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Palworld ë¡œê·¸ì¸/íšŒì›ê°€ì…</title>
<link rel="stylesheet" href="./style.css">
<style>
  .error { color:red; margin-bottom:10px; }
  .login-btn, .signup-btn, .google-btn { display:block; margin:10px 0; padding:8px 12px; }
</style>
</head>
<body>
<div class="container">
  <h2>Palworld ë¡œê·¸ì¸/íšŒì›ê°€ì…</h2>
  <div id="login-msg" class="error"></div>

  <input type="email" id="email" placeholder="ì´ë©”ì¼">
  <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">

  <button id="login-btn" class="login-btn">ë¡œê·¸ì¸</button>
  <button id="signup-btn" class="signup-btn">íšŒì›ê°€ì…</button>
  <button id="google-btn" class="google-btn">Google ë¡œê·¸ì¸</button>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { 
  createUserWithEmailAndPassword, 
  sendEmailVerification, 
  signInWithEmailAndPassword, 
  signInWithPopup, 
  GoogleAuthProvider 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const signupBtn = document.getElementById("signup-btn");
const googleBtn = document.getElementById("google-btn");
const loginMsg = document.getElementById("login-msg");

// ğŸ”¹ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ íšŒì›ê°€ì…
signupBtn.addEventListener("click", async () => {
  loginMsg.textContent = "";
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  if (!email || !password) { loginMsg.textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }

  try {
    // 1ï¸âƒ£ íšŒì›ê°€ì…
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // 2ï¸âƒ£ Firestoreì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
    await setDoc(doc(db, "users", user.uid), {
      email: email,
      isMember: false,   // ë””ìŠ¤ì½”ë“œ ì„œë²„ ê°€ì… ì—¬ë¶€
      createdAt: new Date()
    });

    // 3ï¸âƒ£ ì´ë©”ì¼ ì¸ì¦ ì „ì†¡
    await sendEmailVerification(user);
    alert("íšŒì›ê°€ì… ì„±ê³µ! ì¸ì¦ ì´ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");

  } catch (err) {
    console.error(err);
    loginMsg.textContent = "íšŒì›ê°€ì… ì‹¤íŒ¨: " + err.message;
  }
});

// ğŸ”¹ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸
loginBtn.addEventListener("click", async () => {
  loginMsg.textContent = "";
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  if (!email || !password) { loginMsg.textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // ì´ë©”ì¼ ì¸ì¦ ì²´í¬
    if (!user.emailVerified) {
      alert("ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }

    window.location.href = "home.html"; // ì¸ì¦ ì™„ë£Œ ì‹œ í™ˆ ì´ë™
  } catch (err) {
    console.error(err);
    loginMsg.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message;
  }
});

// ğŸ”¹ êµ¬ê¸€ ë¡œê·¸ì¸
googleBtn.addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try {
    const userCredential = await signInWithPopup(auth, provider);
    const user = userCredential.user;

    // Firestoreì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ìƒì„±
    const userDocRef = doc(db, "users", user.uid);
    const userSnapshot = await userDocRef.get();
    if (!userSnapshot.exists()) {
      await setDoc(userDocRef, {
        email: user.email,
        isMember: false,
        createdAt: new Date()
      });
    }

    // êµ¬ê¸€ ë¡œê·¸ì¸ì€ emailVerified ê¸°ë³¸ true
    window.location.href = "home.html";

  } catch (err) {
    console.error(err);
    loginMsg.textContent = "Google ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message;
  }
});
</script>
</body>
</html>
